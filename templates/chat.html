<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ conversation.title }} - ì±„íŒ…</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        #messages { list-style-type: none; margin: 0; padding: 0; border: 1px solid #ccc; height: 400px; overflow-y: scroll; }
        #messages li { padding: 8px 12px; }
        #messages li:nth-child(odd) { background: #f2f2f2; }
        .message-img { max-width: 200px; max-height: 200px; border-radius: 5px; margin-top: 5px; }
        #chat-form { display: flex; margin-top: 10px; }
        #message-input { flex-grow: 1; padding: 8px; }
        #image-input { display: none; }
        .upload-btn { padding: 8px 12px; cursor: pointer; background: #ddd; border: 1px solid #ccc; }
        button { padding: 8px 12px; }
    </style>
</head>
<body>
    <h1>{{ conversation.title }}</h1>
    <a href="{{ url_for('chat_list') }}">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    <ul id="messages">
        {% for message in messages %}
            <li>
                <strong>{{ message.sender.username }}:</strong> {{ message.content }}
                {% if message.image_path %}
                    <br>
                    <img src="{{ url_for('static', filename=message.image_path.split('static/')[1]) }}" class="message-img">
                {% endif %}
            </li>
        {% endfor %}
    </ul>

    <form id="chat-form" style="margin-top: 10px;">
        <label for="image-input" class="upload-btn">ğŸ–¼ï¸</label>
        <input type="file" id="image-input" accept="image/*">
        
        <input type="text" id="message-input" autocomplete="off" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button type="submit">ì „ì†¡</button>
    </form>

    <script>
        const socket = io();
        const conversationId = {{ conversation.id }};
        const userId = {{ user.id }};

        socket.on('connect', () => {
            socket.emit('join', { conversation_id: conversationId });
        });

        // ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
        socket.on('receive_message', (data) => {
            const item = document.createElement('li');
            let content = `<strong>ì‚¬ìš©ì ${data.sender_id}:</strong> ${data.content}`;
            if (data.image_url) {
                // 'static/uploads/filename.jpg' -> '/static/uploads/filename.jpg'
                const imageUrl = data.image_url.startsWith('/') ? data.image_url : '/' + data.image_url;
                content += `<br><img src="${imageUrl}" class="message-img">`;
            }
            item.innerHTML = content;
            document.getElementById('messages').appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('message-input');
            const imageInput = document.getElementById('image-input');
            const messageText = messageInput.value.trim();
            const imageFile = imageInput.files[0];

            if (!messageText && !imageFile) {
                return; // ë‚´ìš©ê³¼ ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì—†ìœ¼ë©´ ì „ì†¡ ì•ˆ í•¨
            }

            let imageUrl = null;

            // 1. ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì„œë²„ì— ë¨¼ì € ì—…ë¡œë“œ
            if (imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);

                try {
                    const response = await fetch('/upload_image', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (result.image_url) {
                        imageUrl = result.image_url.substring(1); // ë§¨ ì• '/' ì œê±°
                    } else {
                        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + result.error);
                        return;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                    return;
                }
            }

            // 2. í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ URLì„ ì†Œì¼“ìœ¼ë¡œ ì „ì†¡
            socket.emit('send_message', {
                conversation_id: conversationId,
                user_id: userId,
                content: messageText,
                image_url: imageUrl
            });

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            messageInput.value = '';
            imageInput.value = ''; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
        });
    </script>
</body>
</html>