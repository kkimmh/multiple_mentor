<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ conversation.title }} - ì±„íŒ…</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        
        #messages { 
            list-style-type: none; 
            margin: 0; 
            padding: 10px; 
            border: 1px solid #ccc; 
            height: 400px; 
            overflow-y: scroll; 
            display: flex; /* Flexbox í™œì„±í™” */
            flex-direction: column; /* ë©”ì‹œì§€ë¥¼ ì„¸ë¡œë¡œ ìŒ“ìŒ */
        }
        
        /* ê°œë³„ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .message-container {
            display: flex;
            margin-bottom: 10px;
            max-width: 80%; /* ì±„íŒ… í­ ì œí•œ */
        }

        /* ë‚´ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½ ì •ë ¬) */
        .message-right {
            align-self: flex-end; /* ì»¨í…Œì´ë„ˆë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ */
            margin-left: auto;
        }
        /* ìƒëŒ€ë°© ë©”ì‹œì§€ (ì™¼ìª½ ì •ë ¬) */
        .message-left {
            align-self: flex-start; /* ì»¨í…Œì´ë„ˆë¥¼ ì™¼ìª½ìœ¼ë¡œ */
            margin-right: auto;
        }

        /* ë©”ì‹œì§€ ë‚´ìš© ë°•ìŠ¤ */
        .message-bubble {
            padding: 10px;
            border-radius: 15px;
            word-wrap: break-word;
            max-width: 100%;
        }

        /* ë‚´ ë©”ì‹œì§€ ë²„ë¸” */
        .message-right .message-bubble {
            background-color: #dcf8c6; /* ì—°ë‘ìƒ‰ */
        }
        /* ìƒëŒ€ë°© ë©”ì‹œì§€ ë²„ë¸” */
        .message-left .message-bubble {
            background-color: #ffffff; /* í°ìƒ‰ */
            border: 1px solid #ddd;
        }

        .message-info {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        
        .message-img { max-width: 200px; max-height: 200px; border-radius: 5px; margin-top: 5px; display: block; }
        
        #chat-form { display: flex; margin-top: 10px; }
        #message-input { flex-grow: 1; padding: 8px; }
        #image-input { display: none; }
        .upload-btn { padding: 8px 12px; cursor: pointer; background: #ddd; border: 1px solid #ccc; }
        button { padding: 8px 12px; }
    </style>
</head>
<body>
    <h1>{{ conversation.title }}</h1>
    <a href="{{ url_for('chat_list') }}">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    
    <div id="messages">
        {% for message in messages %}
            {% set is_mine = message.sender_id == user.id %}
            <div class="message-container {% if is_mine %}message-right{% else %}message-left{% endif %}">
                <div class="message-bubble">
                    <div class="message-info">
                        <strong>{{ message.sender.username if message.sender else 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì' }}:</strong>
                    </div>
                    
                    {{ message.content }}
                    
                    {% if message.image_path %}
                        <br>
                        {% set img_path = message.image_path.lstrip('/') %}
                        <img src="{{ url_for('static', filename=img_path.split('static/')[1]) if 'static/' in img_path else url_for('static', filename=img_path) }}" class="message-img">
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <form id="chat-form" style="margin-top: 10px;">
        <label for="image-input" class="upload-btn">ğŸ–¼ï¸</label>
        <input type="file" id="image-input" accept="image/*">
        
        <input type="text" id="message-input" autocomplete="off" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button type="submit">ì „ì†¡</button>
    </form>

    <script>
        const socket = io();
        const conversationId = {{ conversation.id }};
        const userId = {{ user.id }};
        const currentUsername = "{{ user.username }}"; // í˜„ì¬ ì‚¬ìš©ì ì´ë¦„

        socket.on('connect', () => {
            socket.emit('join', { conversation_id: conversationId });
        });

        function createMessageElement(data) {
            const isMine = data.sender_id == userId;
            
            const container = document.createElement('div');
            container.classList.add('message-container');
            container.classList.add(isMine ? 'message-right' : 'message-left');

            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');

            // ì‚¬ìš©ìëª… (ì†Œì¼“ ìˆ˜ì‹  ì‹œ sender_idë§Œ ì˜¤ë¯€ë¡œ ì—¬ê¸°ì„œ ì²˜ë¦¬)
            const senderName = isMine ? currentUsername : `ì‚¬ìš©ì ${data.sender_id}`; 
            
            // Render ë°°í¬ ì‹œ ìƒëŒ€ë°© ì´ë¦„(admin1 ë“±)ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° ì–´ë ¤ìš°ë¯€ë¡œ, 
            // í˜„ì¬ëŠ” ì„ì‹œë¡œ "ì‚¬ìš©ì ID" ë˜ëŠ” "ë‚´ ì´ë¦„"ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
            // (ì •í™•í•œ ìƒëŒ€ë°© ì´ë¦„ì„ í‘œì‹œí•˜ë ¤ë©´ ì†Œì¼“ ë©”ì‹œì§€ ì „ì†¡ ì‹œ ìƒëŒ€ë°© ì´ë¦„ ì •ë³´ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.)
            
            let htmlContent = `<div class="message-info"><strong>${isMine ? currentUsername : 'ìƒëŒ€ë°©'}</strong></div>`;
            
            htmlContent += data.content || '';

            if (data.image_url) {
                const imageUrl = data.image_url.startsWith('/') ? data.image_url : '/' + data.image_url;
                htmlContent += `<br><img src="${imageUrl}" class="message-img">`;
            }
            
            bubble.innerHTML = htmlContent;
            container.appendChild(bubble);
            
            return container;
        }


        // ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬ (ì‹¤ì‹œê°„)
        socket.on('receive_message', (data) => {
            const messageElement = createMessageElement(data);
            document.getElementById('messages').appendChild(messageElement);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì´ì „ê³¼ ë™ì¼)
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('message-input');
            const imageInput = document.getElementById('image-input');
            const messageText = messageInput.value.trim();
            const imageFile = imageInput.files[0];

            if (!messageText && !imageFile) {
                return;
            }

            let imageUrl = null;

            // 1. ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì„œë²„ì— ë¨¼ì € ì—…ë¡œë“œ
            if (imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);

                try {
                    const response = await fetch('/upload_image', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (result.image_url) {
                        imageUrl = result.image_url.substring(1);
                    } else {
                        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + result.error);
                        return;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                    return;
                }
            }

            // 2. í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ URLì„ ì†Œì¼“ìœ¼ë¡œ ì „ì†¡
            socket.emit('send_message', {
                conversation_id: conversationId,
                user_id: userId,
                content: messageText,
                image_url: imageUrl
            });

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            messageInput.value = '';
            imageInput.value = '';
        });

        // í˜ì´ì§€ ë¡œë“œ í›„ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
        document.addEventListener('DOMContentLoaded', () => {
            const messageContainer = document.getElementById('messages');
            messageContainer.scrollTop = messageContainer.scrollHeight;
        });
    </script>
</body>
</html>